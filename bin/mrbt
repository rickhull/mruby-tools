#!/usr/bin/env ruby

require 'tempfile'
require 'mruby_tools'

# args like: file1.rb file2.rb -o outfile
#  possibly: file1.rb -o outfile file2.rb -c generated.c

opts = MRubyTools.args(ARGV)
if opts[:help]
  puts <<EOF
  USAGE: mrbt file1.rb file2.rb ...
OPTIONS: -o outfile     (provide a name for the standalone executable)
         -c generated.c (leave the specified C file on the filesystem)
         -v             (verbose)
EOF
  exit
end

out_file = opts.fetch(:out_file)
rb_files = opts.fetch(:rb_files)
c_file = opts.fetch(:c_file)
warn "no .rb files provided" if rb_files.empty?

c_code = MRubyTools.c_wrapper(rb_files)
puts c_code + "\n" if opts[:verbose]

c_file.write(c_code)
c_file.close

msd = MRubyTools.mruby_src_dir

gcc_args = [
  '-std=c99', "-I", File.join(msd, 'include'), c_file.path, "-o", out_file,
  File.join(msd, 'build', 'host', 'lib', 'libmruby.a'), '-lm',
]

puts "compiling..."
puts "created binary executable: #{out_file}" if system('gcc', *gcc_args)
